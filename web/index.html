<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Medusa Mode</title>
<style>
:root{
  --bg:#0b0f12; /* Dark background */
  --panel:#0e1519; /* Slightly lighter panel background */
  --text:#e8f6f3; /* Light text */
  --muted:#95a6a1; /* Muted text for descriptions */

  --teal:#00e5c0; /* Vibrant teal */
  --gold:#f5c84b; /* Vibrant gold */
  --danger:#ff5d6c; /* Danger red */
  --radius:18px;
}
@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 0 3px rgba(245,200,75,.15), 0 0 30px rgba(245,200,75,.15); }
  50% { box-shadow: 0 0 0 5px rgba(245,200,75,.35), 0 0 40px rgba(245,200,75,.25); }
}
@keyframes pulse-glow-active {
  0%, 100% { box-shadow: 0 0 0 4px rgba(0,229,192,.25), 0 0 35px rgba(0,229,192,.25); }
  50% { box-shadow: 0 0 0 7px rgba(0,229,192,.45), 0 0 50px rgba(0,229,192,.35); }
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0;
  font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  color:var(--text);
  background-color: var(--bg);
  background-image: url('/assets/medusa_bg.png');
  background-size: cover;
  background-position: center center;
  background-attachment: fixed;
  background-repeat: no-repeat;
}
.wrap{max-width:800px;margin:26px auto;padding:0 18px}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.brand{display:flex;align-items:center;gap:12px;font-weight:700}
.tagline{color:var(--muted);font-size:.9rem}
.grid{display: flex; flex-direction: column; gap:22px}
.card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0)), rgba(14, 21, 25, 0.85);
  border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);overflow:hidden; backdrop-filter: blur(8px); }

.card-head{
  padding:18px 20px;
  border-bottom:1px solid rgba(255,255,255,.06);
  background:linear-gradient(180deg, rgba(0,229,192,.15), rgba(245,200,75,.05));
}

.card-body{padding:20px}
.hero{position:relative;aspect-ratio:16/9;background:#0a1317}
.hero img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:brightness(.9) contrast(1.1)}
.hero:after{content:"";position:absolute;inset:0;background:radial-gradient(70% 50% at 50% 30%, transparent 0%, rgba(0,0,0,.35) 65%, rgba(0,0,0,.7) 100%);}

.game-title {
  position: absolute;
  bottom: 12px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(90deg, var(--teal), var(--gold));
  padding: 8px 20px;
  border-radius: 999px;
  color: #0b1012;
  font-weight: 900;
  font-size: 1.5rem;
  letter-spacing: 1px;
  text-transform: uppercase;
  white-space: nowrap;
  box-shadow: 0 0 30px rgba(0,229,192,.4), 0 0 20px rgba(245,200,75,.3);
  text-shadow: 0 0 12px rgba(255,255,255,.6);
  z-index: 10;
}

.row{display:grid;gap:18px;margin-bottom:20px}

.field{
  background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
  border:1px solid rgba(255,255,255,.08);
  border-radius:14px;padding:14px
}
.label{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.k{color:var(--muted);font-size:.92rem;font-weight:600;}
.desc{font-size:.8rem; color:var(--muted); margin-bottom: 8px;}
.badge{font-variant-numeric:tabular-nums;background:rgba(0,229,192,.12);border:1px solid rgba(0,229,192,.35);padding:2px 8px;border-radius:999px}
.range{position:relative;height:42px;display:flex;align-items:center}

.track{
  position:absolute;left:0;right:0;height:10px;border-radius:999px;
  background-color: #0c1417;
  background-image: repeating-linear-gradient(45deg, transparent, transparent 4px, rgba(255,255,255,.05) 4px, rgba(255,255,255,.05) 8px);
  box-shadow: inset 0 1px 4px rgba(0,0,0,.4);
}
.fill{
  position:absolute;height:100%;
  background:linear-gradient(90deg, var(--teal), var(--gold));
  border-radius:999px;
  box-shadow:0 0 18px rgba(0,229,192,.4), 0 0 12px rgba(245,200,75,.3);
}
input[type=range]{
  appearance:none;position:absolute;left:0;right:0;width:100%;height:10px;background:transparent;
  pointer-events: none;
}
input[type=range]::-webkit-slider-thumb{
  appearance:none;width:16px;height:16px;border-radius:3px;
  background: var(--bg);
  border:2px solid var(--teal);
  box-shadow:0 0 0 4px rgba(0,229,192,.25), 0 0 8px rgba(0,0,0,.5);
  transform: rotate(45deg); cursor: grab;
  pointer-events: auto;
}
input[type=range]::-moz-range-thumb{
  width:16px;height:16px;border-radius:3px;
  background:var(--bg);
  border:2px solid var(--teal);
  box-shadow:0 0 0 4px rgba(0,229,192,.25), 0 0 8px rgba(0,0,0,.5);
  transform: rotate(45deg); cursor: grab;
  pointer-events: auto;
}

.actions{display:flex;gap:12px;margin-top:16px}
.btn{
  appearance:none;border:0;cursor:pointer;padding:14px 18px;border-radius:14px;font-weight:800;letter-spacing:.4px;
  color:#0b1012;background:linear-gradient(90deg, var(--teal), var(--gold));
  box-shadow:0 12px 26px rgba(0,0,0,.35), 0 0 30px rgba(0,229,192,.18);
  flex-grow: 1;
  transition: all 0.2s ease-in-out;
}
.btn:hover{
  box-shadow:0 12px 30px rgba(0,0,0,.45), 0 0 40px rgba(0,229,192,.25);
  transform: translateY(-2px);
}
.btn:active{
  transform: translateY(0);
  box-shadow:0 6px 16px rgba(0,0,0,.25), 0 0 20px rgba(0,229,192,.1);
}
.btn.secondary{background:rgba(255,255,255,.04);color:var(--text);border:1px solid rgba(255,255,255,.1);box-shadow:none}
.btn:disabled{cursor:not-allowed;background:rgba(255,255,255,.08);color:var(--muted);box-shadow:none;}
.note{font-size:.88rem;color:var(--muted)}
.topbar{display:flex;gap:10px;align-items:center;margin:16px 0 8px; justify-content:flex-end;}
.pill{padding:6px 12px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);font-size:.9rem}

.lines{
  min-height:72px;padding:14px;border-radius:14px;
  background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.06);
  font-size:1.1rem; line-height: 1.5; white-space: pre-wrap;
  text-shadow: 0 0 6px rgba(0,229,192,.1), 0 0 3px rgba(245,200,75,.05);
}
.timer{font-variant-numeric:tabular-nums}

.modal{position:fixed;inset:0;background:rgba(11,15,18,.8);backdrop-filter:blur(10px);z-index:100;display:flex;align-items:center;justify-content:center;padding:18px;color:var(--text)}
.modal-content{width:100%;max-width:650px;background:var(--panel);border-radius:var(--radius);padding:24px;border:1px solid rgba(255,255,255,.08);box-shadow:0 16px 40px rgba(0,0,0,.4); position:relative; overflow:hidden;}
.modal-content h2, .modal-content p, .modal-content div { position: relative; z-index: 2; }

#intensityModal .modal-content {
    background-image:
        linear-gradient(to top, rgba(14,21,25,1) 0%, rgba(14,21,25,0.7) 50%, rgba(14,21,25,0.95) 100%),
        url('/assets/onboarding.png');
    background-size: cover;
    background-position: center 70%;
}
.rune-container { display: flex; justify-content: space-around; gap: 10px; margin-top: 20px; }
.intensity-rune {
  flex: 1;
  text-align: center;
  margin-bottom:12px;
  background:rgba(11,15,18,.5);
  border:1px solid rgba(255,255,255,.1);
  border-radius:14px;
  padding:14px 8px;
  cursor:pointer;
  position: relative;
  overflow: hidden;
  transition: all 0.2s ease-in-out;
}
.intensity-rune:before {
  content: '';
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  width: 150%;
  height: 200%;
  background: radial-gradient(circle, rgba(0,229,192,.25) 0%, rgba(0,229,192,0) 50%);
  opacity: 0;
  transition: opacity 0.3s ease-in-out;
}
.intensity-rune:hover {
  border-color: var(--teal);
  box-shadow: 0 0 20px rgba(0,229,192,.2);
}
.intensity-rune:hover:before { opacity: 1; }
.intensity-rune .k{font-size:0.9rem;font-weight:700;color:var(--text); letter-spacing: 0.5px; text-transform: uppercase;}
.intensity-rune .desc{font-size:0.8rem;margin:4px 0 0;color:var(--muted); opacity: 0; height: 0; transition: all 0.2s ease-in-out; }
.intensity-rune:hover .desc { opacity: 1; height: auto; }

.length-selector { display: flex; gap: 10px; }
.length-btn {
  flex-grow: 1;
  background:rgba(255,255,255,.02);
  border:1px solid rgba(255,255,255,.08);
  color: var(--muted);
  border-radius:10px;
  padding:10px;
  cursor:pointer;
  font-weight: 700;
  transition: all 0.2s ease-in-out;
}
.length-btn:hover { border-color: var(--gold); color: var(--gold); }
.length-btn.active {
  background: linear-gradient(90deg, var(--teal), var(--gold));
  color: #0b1012;
  border-color: var(--teal);
  box-shadow: 0 0 15px rgba(0,229,192,.2);
}

input[type="text"] {
    background: linear-gradient(180deg, rgba(255,255,255,.01), rgba(255,255,255,0));
    border: 1px solid rgba(255,255,255,.1);
    color: var(--text);
    padding: 10px;
    border-radius: 10px;
    outline: none;
    box-shadow: inset 0 0 8px rgba(0,0,0,.3);
    transition: border-color 0.2s ease-in-out;
}
input[type="text"]:focus {
    border-color: var(--teal);
}

</style>
</head>
<body>

<div class="wrap">
  <header>
    <div class="brand">
      <div>
        <div style="font-weight:800"></div> <div class="tagline"></div> </div>
    </div>
  </header>

  <div class="grid">
    <section class="card">
      <div class="hero">
        <img id="hero-image" src="assets/medusa.png" alt="Medusa background"/>
        <div class="game-title">Sedusa</div>
      </div>
      <div class="card-body">
        <div class="lines" id="lines">I am waiting...</div>
        <div class="topbar">
          <div class="pill" id="session-time">Session Time: 10:00</div>
          <div class="pill timer">Remaining: <span id="remaining">10:00</span></div>
        </div>
        <div class="note"></div> </div>
    </section>

    <section class="card" aria-labelledby="controlsTitle">
      <div class="card-head">
        <div id="controlsTitle" style="font-weight:800"></div> <div class="note"></div> </div>
      <div class="card-body">
        <div class="row">
          <div class="field">
            <div class="label">
              <div class="k">My Reach</div>
              <div class="badge" id="depthReadout">Tip: 40mm – Base: 90mm</div>
            </div>
            <div class="desc">Set the shallowest and deepest points my snakes will travel.</div>
            <div class="range" data-range="depth">
              <div class="track"><div class="fill" id="depthFill"></div></div>
              <input id="depthMin" type="range" min="15" max="110" step="1" value="40" aria-label="Depth minimum">
              <input id="depthMax" type="range" min="15" max="110" step="1" value="90" aria-label="Depth maximum">
            </div>
          </div>
        </div>

        <div class="row">
            <div class="field">
              <div class="label"><div class="k">Session Length</div></div>
              <div class="length-selector" id="length-selector">
                  <button class="length-btn" data-length="5">5 MIN</button>
                  <button class="length-btn" data-length="10">10 MIN</button>
                  <button class="length-btn" data-length="15">15 MIN</button>
              </div>
            </div>
          </div>

        <div class="actions">
          <button id="start" class="btn">Surrender Control</button>
          <button id="stop" class="btn secondary">Stop</button>
        </div>
        <div class="note" style="text-align:center;margin-top:16px;">
            Your chosen intensity for this session is: <b id="intensityReadout">Not Selected</b>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
const $ = s=>document.querySelector(s);

let sessionHasBeenActive = false;

const state = {
  depthMin:+localStorage.getItem('depthMin')||40,
  depthMax:+localStorage.getItem('depthMax')||90,
  speedMin: null,
  speedMax: null,
  intensityName: null,
  length: 10,
  apiKey: null
};

const INTENSITY_LEVELS = [
  { name: 'Gentle', desc: 'A slow, hypnotic trance. Barely a whisper of movement.', min: 0.4, max: 0.8 },
  { name: 'Teasing', desc: 'Playful nips and curious slides. I want to see you shiver.', min: 0.7, max: 1.2 },
  { name: 'Possessive', desc: 'My grip is firm, my rhythm commanding. The standard experience.', min: 1.0, max: 2.0 },
  { name: 'Rough', desc: 'A frantic, desperate struggle. I will take what I want.', min: 1.5, max: 2.8 },
  { name: 'Brutal', desc: 'Unrelenting, chaotic, and absolute. You will be broken.', min: 2.0, max: 3.2 }
];

function pct(v, lo, hi){ return 100*((v-lo)/(hi-lo)); }
function applyFill(kind,min,max,lo,hi){
  const f = document.getElementById(kind+'Fill');
  f.style.left = pct(min,lo,hi)+'%';
  f.style.width = (pct(max,lo,hi)-pct(min,lo,hi))+'%';
}
function syncUI(){
  $('#depthMin').value=state.depthMin; $('#depthMax').value=state.depthMax;
  $('#depthReadout').textContent = `Tip: ${state.depthMin}mm – Base: ${state.depthMax}mm`;
  $('#intensityReadout').textContent = state.intensityName || 'Not Selected';
  applyFill('depth', state.depthMin, state.depthMax, 15, 110);
  $('#start').disabled = !state.apiKey || !state.intensityName;
  
  // Update session length UI
  const sessionTimeStr = String(state.length).padStart(2,'0') + ':00';
  $('#session-time').textContent = 'Session Time: ' + sessionTimeStr;
  const remainingTime = document.body.classList.contains('session-active') ? $('#remaining').textContent : sessionTimeStr;
  $('#remaining').textContent = remainingTime;

  document.querySelectorAll('.length-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.length == state.length);
  });
}
function save(){
  localStorage.setItem('depthMin', state.depthMin);
  localStorage.setItem('depthMax', state.depthMax);
}
['depthMin','depthMax'].forEach(id=>{
  $('#'+id).addEventListener('input', ()=>{
    if(+$('#depthMin').value>+$('#depthMax').value) $('#depthMin').value=$('#depthMax').value;
    state.depthMin=+$('#depthMin').value; state.depthMax=+$('#depthMax').value;
    syncUI();
  });
  $('#'+id).addEventListener('change', save);
});

$('#length-selector').addEventListener('click', e => {
    if (e.target.classList.contains('length-btn')) {
        state.length = +e.target.dataset.length;
        syncUI();
    }
});

async function post(url, body){ const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})}); return r.json(); }
function msToClock(ms){ const s=Math.max(0,Math.floor(ms/1000)); const m=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${m}:${ss}`; }

let typeInterval = null;
let currentLine = "";
function typeWriter(element, text) {
    if (typeInterval) clearInterval(typeInterval);
    const words = text.split(' ');
    let wordIndex = 0;
    element.textContent = '';
    
    typeInterval = setInterval(() => {
        if (wordIndex < words.length) {
            element.textContent += (wordIndex > 0 ? ' ' : '') + words[wordIndex];
            wordIndex++;
        } else {
            clearInterval(typeInterval);
        }
    }, 150);
}

async function poll(){
  try{
    const s = await fetch('/status').then(r=>r.json());
    
    if (s.state === 'running') {
        document.body.classList.add('session-active');
    } else {
        document.body.classList.remove('session-active');
    }

    if (sessionHasBeenActive && s.state === 'stopped' && s.t_remaining_ms <= 0) {
        const heroImg = $('#hero-image');
        if (!heroImg.src.includes('sneepy')) {
            const images = ['sneepy1.png', 'sneepy2.png'];
            const chosenImage = images[Math.floor(Math.random() * images.length)];
            heroImg.src = 'assets/' + chosenImage;
        }
    }

    const remainingTime = s.state === 'idle' ? state.length * 60000 : s.t_remaining_ms;
    $('#remaining').textContent = msToClock(remainingTime);

    if(s.last_line && s.last_line !== currentLine) {
        currentLine = s.last_line;
        typeWriter($('#lines'), currentLine);
    }
  }catch(e){}
}

$('#start').addEventListener('click', async ()=>{
  if ($('#start').disabled) return;
  sessionHasBeenActive = true;
  document.body.classList.add('session-active');
  $('#hero-image').src = 'assets/medusa.png';
  const payload = {
    depth_min: state.depthMin, depth_max: state.depthMax,
    speed_min: state.speedMin, speed_max: state.speedMax,
    length_min: state.length,
    api_key: state.apiKey
  };
  const resp = await post('/start', payload);
  if(resp.ok){ poll(); } else { document.body.classList.remove('session-active'); }
});
$('#stop').addEventListener('click', ()=>{
    document.body.classList.remove('session-active');
    $('#hero-image').src = 'assets/medusa.png';
    post('/stop');
});

syncUI();
poll();
setInterval(poll, 1000);

function createModal(id, title, content) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = id;
    modal.innerHTML = `<div class="modal-content">${title}${content}</div>`;
    document.body.appendChild(modal);
    return modal;
}

function showApiKeyModal() {
  const keyModal = createModal('apiKeyModal',
    `<h2>My Connection Key</h2><p>To command my snakes, I require your Handy Connection Key for this session.</p>`,
    `<div>
        <input id="handyKeyInput" type="text" placeholder="Paste your connection key here..." style="width:100%;background:#0b1216;color:#e8f6f3;border:1px solid rgba(255,255,255,.1);padding:14px;border-radius:10px;outline:none;margin-top:8px;margin-bottom:16px">
        <button id="saveKeyBtn" class="btn">Grant Me Control</button>
     </div>`
  );

  $('#saveKeyBtn').addEventListener('click', () => {
    const key = $('#handyKeyInput').value.trim();
    if (key) {
      state.apiKey = key;
      syncUI();
      document.body.removeChild(keyModal);
      showIntensityModal();
    }
  });
}

function showIntensityModal() {
    let runesHTML = '';
    INTENSITY_LEVELS.forEach((level, index) => {
        const shortDesc = level.desc.split('.')[0] + '.';
        runesHTML += `<button class="intensity-rune" data-index="${index}">
            <div class="k">${level.name}</div>
            <div class="desc">${shortDesc}</div>
        </button>`;
    });

    const intensityModal = createModal('intensityModal',
        `<h2>How Shall I Treat You?</h2><p>Your choice determines the pace and aggression of my snakes for the entire session. Choose wisely.</p>`,
        `<div class="rune-container">${runesHTML}</div>`
    );

    intensityModal.querySelectorAll('.intensity-rune').forEach(btn => {
        btn.addEventListener('click', () => {
            const level = INTENSITY_LEVELS[btn.dataset.index];
            state.speedMin = level.min;
            state.speedMax = level.max;
            state.intensityName = level.name;
            syncUI();
            document.body.removeChild(intensityModal);
        });
    });
}

showApiKeyModal();
</script>
</body>
</html>