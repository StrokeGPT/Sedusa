<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Medusa Mode</title>
<style>
:root{
  --bg:#0b0f12; /* Dark background */
  --panel:#0e1519; /* Slightly lighter panel background */
  --text:#e8f6f3; /* Light text */
  --muted:#95a6a1; /* Muted text for descriptions */

  --teal:#00e5c0; /* Vibrant teal */
  --gold:#f5c84b; /* Vibrant gold */
  --danger:#ff5d6c; /* Danger red */
  --radius:18px;
}
@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 0 3px rgba(245,200,75,.15), 0 0 30px rgba(245,200,75,.15); }
  50% { box-shadow: 0 0 0 5px rgba(245,200,75,.35), 0 0 40px rgba(245,200,75,.25); }
}
@keyframes pulse-glow-active {
  0%, 100% { box-shadow: 0 0 0 4px rgba(0,229,192,.25), 0 0 35px rgba(0,229,192,.25); }
  50% { box-shadow: 0 0 0 7px rgba(0,229,192,.45), 0 0 50px rgba(0,229,192,.35); }
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0;
  font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  color:var(--text);
  background-color: var(--bg);
  background-image: url('/assets/medusa_bg.png');
  background-size: cover;
  background-position: center center;
  background-attachment: fixed;
  background-repeat: no-repeat;
}
.wrap{max-width:800px;margin:26px auto;padding:0 18px}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.brand{display:flex;align-items:center;gap:12px;font-weight:700}
/* Removed .logo styling as the element is removed */
/* body.session-active .logo { animation: pulse-glow-active 1.5s ease-in-out infinite; } */
.tagline{color:var(--muted);font-size:.9rem}
.grid{display: flex; flex-direction: column; gap:22px}
.card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0)), rgba(14, 21, 25, 0.85);
  border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);overflow:hidden; backdrop-filter: blur(8px); }

/* Enhanced card header with more prominent gradient */
.card-head{
  padding:18px 20px;
  border-bottom:1px solid rgba(255,255,255,.06);
  background:linear-gradient(180deg, rgba(0,229,192,.15), rgba(245,200,75,.05)); /* Teal to Gold gradient */
}

.card-body{padding:20px}
.hero{position:relative;aspect-ratio:16/9;background:#0a1317}
.hero img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:brightness(.9) contrast(1.1)}
.hero:after{content:"";position:absolute;inset:0;background:radial-gradient(70% 50% at 50% 30%, transparent 0%, rgba(0,0,0,.35) 65%, rgba(0,0,0,.7) 100%);}

/* Styles for the new title (repurposed from .halo) */
.game-title {
  position: absolute;
  bottom: 12px; /* Position at the bottom */
  left: 50%; /* Center horizontally */
  transform: translateX(-50%); /* Adjust for perfect horizontal centering */
  background: linear-gradient(90deg, var(--teal), var(--gold));
  padding: 8px 20px; /* Slightly reduced padding */
  border-radius: 999px;
  color: #0b1012;
  font-weight: 900; /* Bolder font */
  font-size: 1.5rem; /* Reduced font size to fit on one line */
  letter-spacing: 1px; /* Slightly reduced letter spacing */
  text-transform: uppercase; /* All caps for title feel */
  white-space: nowrap; /* Ensure it stays on one line */
  box-shadow: 0 0 30px rgba(0,229,192,.4), 0 0 20px rgba(245,200,75,.3); /* Stronger glow */
  text-shadow: 0 0 12px rgba(255,255,255,.6); /* More prominent text glow */
  z-index: 10; /* Ensure it's above the image overlay */
}

.row{display:grid;gap:18px;margin-bottom:20px}

/* Input fields with subtle gradient */
.field{
  background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); /* Subtle gradient */
  border:1px solid rgba(255,255,255,.08);
  border-radius:14px;padding:14px
}
.label{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.k{color:var(--muted);font-size:.92rem;font-weight:600;}
.desc{font-size:.8rem; color:var(--muted); margin-bottom: 8px;}
.badge{font-variant-numeric:tabular-nums;background:rgba(0,229,192,.12);border:1px solid rgba(0,229,192,.35);padding:2px 8px;border-radius:999px}
.range{position:relative;height:42px;display:flex;align-items:center}
.track{position:absolute;left:0;right:0;height:6px;border-radius:999px;background:linear-gradient(90deg, rgba(255,255,255,.1), rgba(255,255,255,.06))}
.fill{position:absolute;height:100%;background:linear-gradient(90deg, var(--teal), var(--gold));border-radius:999px;box-shadow:0 0 16px rgba(0,229,192,.25)}
input[type=range]{appearance:none;position:absolute;left:0;right:0;width:100%;height:6px;background:transparent}
input[type=range]::-webkit-slider-thumb{appearance:none;width:18px;height:18px;border-radius:50%;background:#0c1417;border:2px solid var(--teal);box-shadow:0 0 0 4px rgba(0,229,192,.2)}
input[type=range]::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:#0c1417;border:2px solid var(--teal);box-shadow:0 0 0 4px rgba(0,229,192,.2)}
.actions{display:flex;gap:12px;margin-top:16px}
.btn{
  appearance:none;border:0;cursor:pointer;padding:14px 18px;border-radius:14px;font-weight:800;letter-spacing:.4px;
  color:#0b1012;background:linear-gradient(90deg, var(--teal), var(--gold));
  box-shadow:0 12px 26px rgba(0,0,0,.35), 0 0 30px rgba(0,229,192,.18);
  flex-grow: 1;
  transition: all 0.2s ease-in-out; /* Smooth transition for hover/active */
}
.btn:hover{
  box-shadow:0 12px 30px rgba(0,0,0,.45), 0 0 40px rgba(0,229,192,.25); /* More prominent shadow on hover */
  transform: translateY(-2px); /* Slight lift */
}
.btn:active{
  transform: translateY(0); /* Press down effect */
  box-shadow:0 6px 16px rgba(0,0,0,.25), 0 0 20px rgba(0,229,192,.1);
}
.btn.secondary{background:rgba(255,255,255,.04);color:var(--text);border:1px solid rgba(255,255,255,.1);box-shadow:none}
.btn:disabled{cursor:not-allowed;background:rgba(255,255,255,.08);color:var(--muted);box-shadow:none;}
.note{font-size:.88rem;color:var(--muted)}
.topbar{display:flex;gap:10px;align-items:center;margin:16px 0 8px; justify-content:flex-end;}
.pill{padding:6px 12px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);font-size:.9rem}

/* Main narrative text with subtle glow */
.lines{
  min-height:72px;padding:14px;border-radius:14px;
  background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.06);
  font-size:1.1rem; line-height: 1.5; white-space: pre-wrap;
  text-shadow: 0 0 6px rgba(0,229,192,.1), 0 0 3px rgba(245,200,75,.05); /* Teal and gold subtle glow */
}
.timer{font-variant-numeric:tabular-nums}

.modal{position:fixed;inset:0;background:rgba(11,15,18,.8);backdrop-filter:blur(10px);z-index:100;display:flex;align-items:center;justify-content:center;padding:18px;color:var(--text)}
.modal-content{width:100%;max-width:500px;background:var(--panel);border-radius:var(--radius);padding:24px;border:1px solid rgba(255,255,255,.08);box-shadow:0 16px 40px rgba(0,0,0,.4); position:relative; overflow:hidden;}
.modal-content h2, .modal-content p, .modal-content div { position: relative; z-index: 2; }

#intensityModal .modal-content {
    background-image:
        linear-gradient(to top, rgba(14,21,25,1) 0%, rgba(14,21,25,0.7) 50%, rgba(14,21,25,0.95) 100%),
        url('/assets/onboarding.png');
    background-size: cover;
    background-position: center 70%;
}

.intensity-btn{display:block;width:100%;text-align:left;margin-bottom:12px;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px;cursor:pointer;}
.intensity-btn:hover{border-color:var(--teal);}
.intensity-btn .k{font-size:1rem;font-weight:700;color:var(--text);}
.intensity-btn .desc{font-size:0.9rem;margin:4px 0 0;color:var(--muted);}

/* Text input specific styling */
input[type="text"] {
    background: linear-gradient(180deg, rgba(255,255,255,.01), rgba(255,255,255,0)); /* Lighter gradient for input */
    border: 1px solid rgba(255,255,255,.1);
    color: var(--text);
    padding: 10px;
    border-radius: 10px;
    outline: none;
    box-shadow: inset 0 0 8px rgba(0,0,0,.3); /* Inner shadow for depth */
    transition: border-color 0.2s ease-in-out;
}
input[type="text"]:focus {
    border-color: var(--teal); /* Highlight border on focus */
}

</style>
</head>
<body>

<div class="wrap">
  <header>
    <div class="brand">
      <div>
        <div style="font-weight:800"></div> <div class="tagline"></div> </div>
    </div>
  </header>

  <div class="grid">
    <section class="card">
      <div class="hero">
        <img src="assets/medusa.png" alt="Medusa background"/>
        <div class="game-title">Sedusa • Story Mode</div>
      </div>
      <div class="card-body">
        <div class="lines" id="lines">I am waiting...</div>
        <div class="topbar">
          <div class="pill">Session Time: 10:00</div>
          <div class="pill timer">Remaining: <span id="remaining">10:00</span></div>
        </div>
        <div class="note"></div> </div>
    </section>

    <section class="card" aria-labelledby="controlsTitle">
      <div class="card-head">
        <div id="controlsTitle" style="font-weight:800"></div> <div class="note"></div> </div>
      <div class="card-body">
        <div class="row">
          <div class="field">
            <div class="label">
              <div class="k">My Reach</div>
              <div class="badge" id="depthReadout">Tip: 40mm – Base: 90mm</div>
            </div>
            <div class="desc">Set the shallowest and deepest points my snakes will travel.</div>
            <div class="range" data-range="depth">
              <div class="track"><div class="fill" id="depthFill"></div></div>
              <input id="depthMin" type="range" min="15" max="110" step="1" value="40" aria-label="Depth minimum">
              <input id="depthMax" type="range" min="15" max="110" step="1" value="90" aria-label="Depth maximum">
            </div>
          </div>
        </div>

        <div class="row">
           <div class="field">
            <div class="label"><div class="k">Your Name (Optional)</div></div>
            <input id="name" type="text" placeholder="Tell me what to call you..."/>
          </div>
        </div>

        <div class="actions">
          <button id="start" class="btn">Surrender Control</button>
          <button id="stop" class="btn secondary">Stop</button>
        </div>
        <div class="note" style="text-align:center;margin-top:16px;">
            Your chosen intensity for this session is: <b id="intensityReadout">Not Selected</b>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
const $ = s=>document.querySelector(s);

const state = {
  depthMin:+localStorage.getItem('depthMin')||40,
  depthMax:+localStorage.getItem('depthMax')||90,
  speedMin: null,
  speedMax: null,
  intensityName: null,
  length: 10,
  name: localStorage.getItem('name') || "",
  apiKey: null
};

const INTENSITY_LEVELS = [
  { name: 'Gentle Coils', desc: 'A slow, hypnotic trance. Barely a whisper of movement.', min: 0.4, max: 0.8 },
  { name: 'Teasing Testers', desc: 'Playful nips and curious slides. I want to see you shiver.', min: 0.7, max: 1.2 },
  { name: 'Possessive Embrace', desc: 'My grip is firm, my rhythm commanding. The standard experience.', min: 1.0, max: 2.0 },
  { name: 'Rough Claiming', desc: 'A frantic, desperate struggle. I will take what I want.', min: 1.5, max: 2.8 },
  { name: 'Overwhelming Gaze', desc: 'Unrelenting, chaotic, and absolute. You will be broken.', min: 2.0, max: 3.2 }
];

function pct(v, lo, hi){ return 100*((v-lo)/(hi-lo)); }
function applyFill(kind,min,max,lo,hi){
  const f = document.getElementById(kind+'Fill');
  f.style.left = pct(min,lo,hi)+'%';
  f.style.width = (pct(max,lo,hi)-pct(min,lo,hi))+'%';
}
function syncUI(){
  $('#depthMin').value=state.depthMin; $('#depthMax').value=state.depthMax;
  $('#name').value=state.name;
  // Updated formatting for depthReadout
  $('#depthReadout').textContent = `Tip: ${state.depthMin}mm – Base: ${state.depthMax}mm`;
  $('#intensityReadout').textContent = state.intensityName || 'Not Selected';
  applyFill('depth', state.depthMin, state.depthMax, 15, 110);
  $('#start').disabled = !state.intensityName;
}
function save(){
  // API key is no longer saved client-side
  localStorage.setItem('depthMin', state.depthMin);
  localStorage.setItem('depthMax', state.depthMax);
  localStorage.setItem('name', state.name);
}
['depthMin','depthMax'].forEach(id=>{
  $('#'+id).addEventListener('input', ()=>{
    if(+$('#depthMin').value>+$('#depthMax').value) $('#depthMin').value=$('#depthMax').value;
    state.depthMin=+$('#depthMin').value; state.depthMax=+$('#depthMax').value;
    syncUI();
  });
  $('#'+id).addEventListener('change', save);
});
$('#name').addEventListener('change', e=>{ state.name=e.target.value.trim(); save(); });

async function post(url, body){ const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})}); return r.json(); }
function msToClock(ms){ const s=Math.max(0,Math.floor(ms/1000)); const m=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${m}:${ss}`; }

async function poll(){
  try{
    const s = await fetch('/status').then(r=>r.json());
    if (s.state === 'running') {
        document.body.classList.add('session-active');
    } else {
        document.body.classList.remove('session-active');
    }
    $('#remaining').textContent = msToClock(s.t_remaining_ms||(state.length * 60000));
    if(s.last_line) $('#lines').textContent = s.last_line;
  }catch(e){}
}

$('#start').addEventListener('click', async ()=>{
  if ($('#start').disabled) return;
  document.body.classList.add('session-active');
  const payload = {
    depth_min: state.depthMin, depth_max: state.depthMax,
    speed_min: state.speedMin, speed_max: state.speedMax,
    length_min: state.length, name: state.name || null,
    // API key is no longer sent from client on start, it's server-side
    // api_key: state.apiKey
  };
  const resp = await post('/start', payload);
  if(resp.ok){ poll(); } else { document.body.classList.remove('session-active'); }
});
$('#stop').addEventListener('click', ()=>{
    document.body.classList.remove('session-active');
    post('/stop');
});

syncUI();
poll();
setInterval(poll, 1000);

function createModal(id, title, content) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = id;
    modal.innerHTML = `<div class="modal-content">${title}${content}</div>`;
    document.body.appendChild(modal);
    return modal;
}

async function initOnboarding() {
  // Check if API key exists on the server
  const checkKeyResponse = await fetch('/check_api_key').then(r => r.json());
  if (checkKeyResponse.has_api_key) {
    // If server has key, proceed directly to intensity modal
    showIntensityModal();
    return;
  }
  
  const keyModal = createModal('apiKeyModal',
    `<h2>My Connection Key</h2><p>To command your device, I require your Handy Connection Key. It will be securely saved on the server for future use.</p>`,
    `<div>
        <input id="handyKeyInput" type="text" placeholder="Paste your connection key here..." style="width:100%;background:#0b1216;color:#e8f6f3;border:1px solid rgba(255,255,255,.1);padding:14px;border-radius:10px;outline:none;margin-top:8px;margin-bottom:16px">
        <button id="saveKeyBtn" class="btn">Grant Me Control</button>
     </div>`
  );

  $('#saveKeyBtn').addEventListener('click', async () => {
    const key = $('#handyKeyInput').value.trim();
    if (key) {
      // Send key to server to save
      const saveResponse = await post('/save_api_key', { api_key: key });
      if (saveResponse.ok) {
        document.body.removeChild(keyModal);
        showIntensityModal();
      } else {
        alert("Failed to save API key on server: " + saveResponse.error);
      }
    }
  });
}

function showIntensityModal() {
    let buttonsHTML = '';
    INTENSITY_LEVELS.forEach((level, index) => {
        buttonsHTML += `<button class="intensity-btn" data-index="${index}">
            <div class="k">${level.name}</div>
            <div class="desc">${level.desc}</div>
        </button>`;
    });

    const intensityModal = createModal('intensityModal',
        `<h2>How Shall I Treat You?</h2><p>Your choice determines the pace and aggression of my snakes for the entire session. Choose wisely.</p>`,
        `<div>${buttonsHTML}</div>`
    );

    intensityModal.querySelectorAll('.intensity-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const level = INTENSITY_LEVELS[btn.dataset.index];
            state.speedMin = level.min;
            state.speedMax = level.max;
            state.intensityName = level.name;
            syncUI();
            document.body.removeChild(intensityModal);
        });
    });
}

initOnboarding();
</script>
</body>
</html>